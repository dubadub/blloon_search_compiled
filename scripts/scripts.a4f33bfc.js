"use strict";angular.module("blloonSearchApp",["ct.ui.router.extras","debounce","infinite-scroll","ngAnimate","ngLodash","ngResource","ngSanitize","ngTouch","truncate","ui.bootstrap.modal","ui.bootstrap.tpls"]).config(["$stateProvider","$stickyStateProvider","$urlRouterProvider",function(a,b,c){function d(a,b,c){c.includes("main")&&b.memo("modalInvoker"),a.open({templateUrl:"views/book.html",controller:"BookCtrl",resolve:{previousState:function(){return b}}})}d.$inject=["$modal","$previousState","$state"],a.state("main",{"abstract":!0,url:"/",views:{"main@":{controller:"MainCtrl",templateUrl:"views/main.html"}},sticky:!0}).state("main.search",{url:"?search"}).state("book",{url:"/book/:bookId",template:"<div ui-view></div>",onEnter:d}),c.otherwise("/")}]),angular.module("blloonSearchApp").controller("BookCtrl",["$modalInstance","$scope","$state","$stateParams","Book","previousState",function(a,b,c,d,e,f){b.book=e.get({bookId:d.bookId}),b.close=function(){a.dismiss("close")},a.result.finally(function(){f.get("modalInvoker")?f.go("modalInvoker"):c.go("main.search")}),b.$on("$stateChangeStart",function(b,c){c.$$state().includes.book||a.dismiss("close")})}]).directive("adjustViewportHeight",["$timeout","$window",function(a,b){return{restrict:"A",link:function(c,d,e){function f(){a(function(){var a=g[0].offsetWidth,c=b.innerHeight-3*parseInt(d.css("fontSize")),e=c/a*100;d.css({paddingTop:e+"%"})},100)}var g=angular.element(e.adjustViewportHeight);c.$watchCollection(function(){return[g.height(),d.height(),d.css("fontSize")]},f),angular.element(b).on("resize",f)}}}]),angular.module("blloonSearchApp").controller("MainCtrl",["$location","$scope","$state","$urlRouter","blloonConfig","Book",function(a,b,c,d,e,f){var g,h=0;b.books=[],b.query=a.search().search||"";var i=function(a){return b.isLoading=!0,f.query(a,function(a,c){b.isLoading=!1,g=c("total")})};b.$watch("query",function(a){b.books=a?i({q:a,page:h=0}):[]}),b.loadMore=function(){i({q:b.query,page:++h}).$promise.then(function(a){b.books=b.books.concat(a)})},b.isMoreAvailiable=function(){return(h+1)*e.perPage<g},b.canLoadMore=function(){return b.books.length&&!b.isLoading&&b.isMoreAvailiable()},b.$watch(function(){return c.params.search},function(a){c.is("main.search")&&(b.query=a)}),b.$watch("query",function(b){b?a.search("search",b):a.url(a.path())})}]),angular.module("blloonSearchApp").directive("backgroundImage",["$document",function(a){return{restrict:"A",scope:{backgroundImage:"="},link:function(b,c){b.$watch("backgroundImage",function(){var d=b.backgroundImage;if(d){var e=a[0].createElement("img");e.onload=function(){c.css({backgroundImage:"url("+this.src+")"}),c.addClass("loaded")},e.src=d}})}}}]),angular.module("blloonSearchApp").directive("booksBlock",["$compile","lodash",function(a,b){var c=["lime","green","gold","purple","orange","red"],d='<a class="book" ui-sref="book({ bookId: book.udid})" ng-repeat="book in booksBlock"><div class="book-cover" background-image="book.small_cover_image_url"></div></a>',e='<a class="book" ui-sref="book({ bookId: booksBlock[0].udid})"><div class="book-cover" background-image="booksBlock[0].medium_cover_image_url"></div></a>',f='<a class="book" ui-sref="book({ bookId: booksBlock.udid})"><div class="book-cover" background-image="booksBlock.small_cover_image_url"></div></a>',g=function(a){var b="";switch(a.length){case 1:b=e;break;case 2:b=d;break;case void 0:b=f}return b},h=function(a){var d="";switch(a.length){case 1:d="feature "+b.sample(c);break;case 2:d="two-y"}return d},i=function(b,c){var d=g(b.booksBlock),e=h(b.booksBlock);c.html(d).addClass(e).show(),a(c.contents())(b)};return{restrict:"A",link:i,scope:{booksBlock:"="}}}]),angular.module("blloonSearchApp").directive("scrollTo",["$timeout","$window",function(a,b){function c(a){return function(){var c=angular.element(a.container),d="number"==typeof a.scrollTo?a.scrollTo:angular.element(a.scrollTo),e="number"==typeof d?d:d.offset().top-a.offset;c.animate({scrollTop:c.scrollTop()+e-b.scrollY},a.duration,a.easing)}}return{restrict:"A",link:function(b,d,e){var f=angular.extend({container:"html, body",scrollTo:angular.element(),offset:0,duration:150,easing:"swing"},e);d.on("click",function(){a(c(f))})}}}]),angular.module("blloonSearchApp").filter("toPuzzle",["$cacheFactory","blloonConfig","lodash",function(a,b,c){function d(a){return void 0!==a?c.pluck(a.slice(0,b.perPage),"udid").join():void 0}var e=a("toPuzzle"),f=[2,1,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,1,2,1,2,2,2,2,2,2,2,2,1];return function(a){if(0===a.length)return a;for(var c,g=[],h=0,i=0,j=d(a),k=a.length<=b.perPage?a.length:b.perPage;k>i;)g.push(a.slice(i,i+f[h])),i+=f[h],h+=1;return c=e.get(j),d(c)===d(g)?(a.length>b.perPage&&(c=c.concat(a.slice(b.perPage))),c):(e.put(j,g),a.length>b.perPage&&(g=g.concat(a.slice(b.perPage))),g)}}]),angular.module("blloonSearchApp").constant("blloonConfig",{perPage:36}),angular.module("blloonSearchApp").factory("Book",["$resource","blloonConfig",function(a,b){return a("http://turbine-staging-eu.herokuapp.com/books/:bookId",{bookId:"@udid"},{query:{params:{per_page:b.perPage},isArray:!0}})}]);